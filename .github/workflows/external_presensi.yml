name: External Presensi Automation

on:
  schedule:
    # 06:15 WITA (UTC+8) -> 22:15 UTC (previous day)
    - cron: "15 22 * * *"
    # 16:00 WITA (UTC+8) -> 08:00 UTC
    - cron: "0 8 * * *"
  workflow_dispatch:
    inputs:
      action:
        description: "Aksi presensi"
        required: true
        type: choice
        default: MASUK
        options:
          - MASUK
          - KELUAR
      full_name:
        description: "Override nama lengkap (opsional)"
        required: false
      unit:
        description: "Override unit (opsional)"
        required: false

jobs:
  presensi:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: external-presensi-${{ github.event.schedule || github.run_id }}
      cancel-in-progress: false

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate Required Secrets
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ALLOWED_TELEGRAM_ID: ${{ secrets.ALLOWED_TELEGRAM_ID }}
        run: |
          [ -n "$TELEGRAM_BOT_TOKEN" ] || { echo "::error::Missing secret: TELEGRAM_BOT_TOKEN"; exit 1; }
          [ -n "$ALLOWED_TELEGRAM_ID" ] || { echo "::error::Missing secret: ALLOWED_TELEGRAM_ID"; exit 1; }

      - name: Resolve Scheduled Action
        env:
          EVENT_NAME: ${{ github.event_name }}
          EVENT_SCHEDULE: ${{ github.event.schedule }}
          DISPATCH_ACTION: ${{ github.event.inputs.action }}
          DISPATCH_FULL_NAME: ${{ github.event.inputs.full_name }}
          DISPATCH_UNIT: ${{ github.event.inputs.unit }}
          DEFAULT_FULL_NAME: ${{ secrets.PRESENSI_FULL_NAME || 'Made Dhyo Pradnyadiva' }}
          DEFAULT_UNIT: ${{ secrets.PRESENSI_UNIT || 'Pengembangan Aplikasi' }}
        run: |
          ACTION="$DISPATCH_ACTION"
          if [ -z "$ACTION" ]; then
            case "$EVENT_SCHEDULE" in
              "15 22 * * *") ACTION="MASUK" ;;
              "0 8 * * *") ACTION="KELUAR" ;;
              *)
                echo "::error::Unmapped schedule: $EVENT_SCHEDULE"
                exit 1
                ;;
            esac
          fi

          FULL_NAME="$DEFAULT_FULL_NAME"
          if [ -n "$DISPATCH_FULL_NAME" ]; then
            FULL_NAME="$DISPATCH_FULL_NAME"
          fi

          UNIT="$DEFAULT_UNIT"
          if [ -n "$DISPATCH_UNIT" ]; then
            UNIT="$DISPATCH_UNIT"
          fi

          echo "PRESENSI_ACTION=$ACTION" >> "$GITHUB_ENV"
          echo "PRESENSI_FULL_NAME=$FULL_NAME" >> "$GITHUB_ENV"
          echo "PRESENSI_UNIT=$UNIT" >> "$GITHUB_ENV"
          echo "Resolved ACTION=$ACTION"

      - name: Run External Presensi Runner
        env:
          PRESENSI_ENABLED: ${{ secrets.PRESENSI_ENABLED || 'true' }}
          PRESENSI_URL: ${{ secrets.PRESENSI_URL || 'https://script.google.com/macros/s/AKfycbz5M9sws7DUOiTWCt3vyCgUiMsXkTN-M72sjC4hdyyMGGyHVKm99d-gmwemYQVA7Q0f/exec' }}
          PRESENSI_SHOW_BROWSER: false
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ALLOWED_TELEGRAM_ID: ${{ secrets.ALLOWED_TELEGRAM_ID }}
        run: python src/external_presensi_runner.py
