name: Daily AutoAbsen

on:
  schedule:
    # 15:30 WITA (UTC+8) -> 07:30 UTC
    - cron: '30 7 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  report:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # Hard limit slightly above script timeout
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Show Trigger Context
        run: |
          echo "Triggered by: ${{ github.event_name }}"
          echo "Cron value: ${{ github.event.schedule }}"
          date -u

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify Browser Availability
        run: |
          if command -v google-chrome >/dev/null 2>&1; then
            google-chrome --version
          elif command -v chromium-browser >/dev/null 2>&1; then
            chromium-browser --version
          elif command -v chromium >/dev/null 2>&1; then
            chromium --version
          else
            echo "::error::No Chrome/Chromium binary found on runner."
            exit 1
          fi

      - name: Validate Required Secrets
        env:
          MAGANGHUB_EMAIL: ${{ secrets.MAGANGHUB_EMAIL }}
          MAGANGHUB_PASSWORD: ${{ secrets.MAGANGHUB_PASSWORD }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ALLOWED_TELEGRAM_ID: ${{ secrets.ALLOWED_TELEGRAM_ID }}
        run: |
          [ -n "$MAGANGHUB_EMAIL" ] || { echo "::error::Missing secret: MAGANGHUB_EMAIL"; exit 1; }
          [ -n "$MAGANGHUB_PASSWORD" ] || { echo "::error::Missing secret: MAGANGHUB_PASSWORD"; exit 1; }
          [ -n "$OPENROUTER_API_KEY" ] || { echo "::error::Missing secret: OPENROUTER_API_KEY"; exit 1; }
          [ -n "$TELEGRAM_BOT_TOKEN" ] || { echo "::error::Missing secret: TELEGRAM_BOT_TOKEN"; exit 1; }
          [ -n "$ALLOWED_TELEGRAM_ID" ] || { echo "::error::Missing secret: ALLOWED_TELEGRAM_ID"; exit 1; }

      - name: Run Interactive Runner
        env:
          MAGANGHUB_EMAIL: ${{ secrets.MAGANGHUB_EMAIL }}
          MAGANGHUB_PASSWORD: ${{ secrets.MAGANGHUB_PASSWORD }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          ALLOWED_TELEGRAM_ID: ${{ secrets.ALLOWED_TELEGRAM_ID }}
          AKTIVITAS_KONTEKS: ${{ secrets.AKTIVITAS_KONTEKS || 'Mahasiswa Magang IT' }}
          SHOW_BROWSER: false
          HEADLESS_MODE: true
        run: python src/workflow_runner.py
